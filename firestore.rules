/**
 * @file Firebase Security Rules for ExitPass Application
 * @core_philosophy This ruleset enforces a strict user-ownership model for user profiles and their associated clearance items.
 * It also incorporates role-based access control for administrative functions.
 * @data_structure All user data is nested under /users/{userId}, with clearance items further nested under each user's profile.
 *  Admin roles are managed through the /roles_admin/{userId} collection.
 * @key_security_decisions User listing is disabled to protect user privacy.  Admin status is determined by the existence
 * of a document in the /roles_admin/{userId} collection.
 * @denormalization UserProfile documents are required to have an 'id' field that matches the userId in the path, ensuring
 *  path-based authorization is reliable. ClearanceItems denormalize the userProfileId, mirroring the userId parameter.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile documents. Only the authenticated user can read or write their own profile.
     * @path /users/{userId}
     * @allow (create) User with UID 'user_abc' can create a profile at /users/user_abc.
     * @allow (get, update, delete) User with UID 'user_abc' can read/update/delete their profile at /users/user_abc.
     * @deny (create) User with UID 'user_xyz' cannot create a profile at /users/user_abc.
     * @deny (get, update, delete) User with UID 'user_xyz' cannot read/update/delete the profile at /users/user_abc.
     * @principle Enforces document ownership for writes and restricts access to a user's own data.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false; // User listing is not permitted for privacy.
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to clearance items for a specific user. Only the owner can manage their clearance items.
     * @path /users/{userId}/clearanceItems/{clearanceItemId}
     * @allow (create) User with UID 'user_abc' can create a clearance item under /users/user_abc/clearanceItems/item_1.
     * @allow (get, list, update, delete) User with UID 'user_abc' can read/list/update/delete their clearance items under /users/user_abc/clearanceItems/.
     * @deny (create) User with UID 'user_xyz' cannot create a clearance item under /users/user_abc/clearanceItems/item_1.
     * @deny (get, list, update, delete) User with UID 'user_xyz' cannot read/list/update/delete clearance items under /users/user_abc/clearanceItems/.
     * @principle Enforces document ownership and prevents unauthorized access to clearance items.
     */
    match /users/{userId}/clearanceItems/{clearanceItemId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }
      
      function isAdmin() {
          return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
      }

      allow get: if isOwner(userId) || isAdmin();
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.userProfileId == userId;
      allow update: if (isExistingOwner(userId) && request.resource.data.userProfileId == userId) || isAdmin();
      allow delete: if isExistingOwner(userId);
    }

      /**
       * @description Restricts access to the `roles_admin` collection to only allow administrators to manage admin roles. The existence of a document
       *  at `/roles_admin/{userId}` grants admin privileges to the user with the corresponding `userId`.
       * @path /roles_admin/{userId}
       * @allow (create) Allow creation of admin role for the current user.
       * @allow (get, update, delete) If the user has an existing admin role, allow read/write access.
       * @deny (create, update, delete) Deny create/update/delete access to non-admin users
       * @principle Role-based access control for administrative functions.
       */
      match /roles_admin/{userId} {
        function isSignedIn() {
          return request.auth != null;
        }

        function isAdmin() {
            return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
        }

        allow get: if isAdmin();
        allow list: if false;
        allow create: if isSignedIn() && isAdmin();
        allow update: if isAdmin() && resource != null;
        allow delete: if isAdmin() && resource != null;
      }
  }
}
