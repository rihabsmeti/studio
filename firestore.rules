/**
 * @file Firebase Security Rules for ExitPass Application
 * @core_philosophy This ruleset enforces a strict user-ownership model for user profiles and their associated clearance items.
 * It also incorporates role-based access control for administrative functions.
 * @data_structure All user data is nested under /users/{userId}, with clearance items further nested under each user's profile.
 *  Admin roles are managed through the /roles_admin/{userId} collection.
 * @key_security_decisions User listing is disabled to protect user privacy.  Admin status is determined by the existence
 * of a document in the /roles_admin/{userId} collection.
 * @denormalization UserProfile documents are required to have an 'id' field that matches the userId in the path, ensuring
 *  path-based authorization is reliable. ClearanceItems denormalize the userProfileId, mirroring the userId parameter.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile documents. Only the authenticated user can read or write their own profile.
     * @path /users/{userId}
     * @allow (create) User with UID 'user_abc' can create a profile at /users/user_abc.
     * @allow (get, update, delete) User with UID 'user_abc' can read/update/delete their profile at /users/user_abc.
     * @deny (create) User with UID 'user_xyz' cannot create a profile at /users/user_abc.
     * @deny (get, update, delete) User with UID 'user_xyz' cannot read/update/delete the profile at /users/user_abc.
     * @principle Enforces document ownership for writes and restricts access to a user's own data.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      
      function isStaffRole(role) {
        return role in ['Admin', 'Security', 'Finance'];
      }

      allow get: if isOwner(userId);
      allow list: if false; // User listing is not permitted for privacy.
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == userId
                  && (isStaffRole(request.resource.data.role) == false || request.resource.data.email.matches('.*@africanleadershipacademy.org'));

      allow update: if isOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isOwner(userId);
    }
    
    /**
     * @description Controls access to clearance items for a specific user.
     * @path /users/{userId}/clearanceItems/{clearanceItemId}
     * @principle Enforces document ownership and allows staff to manage items via collection group queries.
     */
    match /users/{userId}/clearanceItems/{clearanceItemId} {
       function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      
      function isStaff() {
        // This function uses `get()` which is allowed for `get` and `update` rules,
        // but NOT for `list` rules. This is why staff access is handled by the collectionGroup query.
        let userRole = get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
        return userRole in ['Admin', 'Security', 'Finance'];
      }

      // allow list for owner works for direct collection queries.
      // staff will use a collectionGroup query which relies on the 'get' permission below.
      allow list: if isOwner(userId);

      // Allow get/update by owner OR staff.
      allow get, update: if isOwner(userId) || isStaff();
      
      // Only owner can create or delete their own items.
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.userProfileId == userId;
      allow delete: if isOwner(userId);
    }
    
    /**
     * @description DEPRECATED. Admin roles are now stored in the user's profile. This collection is no longer in use but the rule remains to prevent accidental creation.
     */
    match /roles_admin/{userId} {
      allow read, write: if false;
    }
  }
}
